#!/bin/bash

# Resolve script directory portably (works on macOS without readlink -f)
SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)"

# Usage: ./mpvcomp main.mp4 extra1.mp4 extra2.mp4 ...
if [ $# -lt 1 ]; then
    echo "Usage: $0 main.mp4 [more.mp4 ...]"
    exit 1
fi

main="$1"
shift

# Pass additional videos as external files and add a placeholder lavfi graph
externals=()
lavfi=""
idx=2
for f in "$@"; do
    externals+=(--external-file="$f")
    lavfi+="[vid$idx]nullsink;"
    ((idx++))
done

# Verify mpv is available
if ! command -v mpv >/dev/null 2>&1; then
    echo "Error: mpv not found in PATH. Install mpv or add it to your PATH." >&2
    exit 127
fi

# Minimal placeholder: main video passthrough; Lua will detect and replace with grid
lavfi+="[vid1]copy[vo]"

mpv "$main" "${externals[@]}" --lavfi-complex="$lavfi" --loop --script="${SCRIPT_PATH}/video_comparison_tool.lua"
